<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Local Loop - Deal</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet (map) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    #map { height: 320px; }
  </style>
</head>
<body class="bg-orange-100 text-gray-900 min-h-screen p-6">

  <!-- Header -->
  <header class="max-w-3xl mx-auto mb-6 relative">
  <img src="logo_transparent.png" alt="Local Loop Logo" class="h-16 mb-4 mx-auto" />
  <button id="backBtn"
    class="absolute left-0 top-1/2 -translate-y-1/2 bg-orange-500 text-white px-4 py-2 rounded-xl shadow-md font-semibold transition hover:bg-orange-600 hover:shadow-lg">
    ← Back to Results
  </button>
  </header>


  <!-- Main content -->
  <main class="max-w-3xl mx-auto bg-white rounded-2xl shadow p-5">
    <h1 id="dealName" class="text-2xl font-bold mb-1">Deal Name</h1>
    <p id="dealType" class="text-sm text-gray-600 mb-4">Type</p>

    <div class="mb-4">
      <p class="text-base">
        <span class="font-semibold">Location:</span>
        <span id="locationName">—</span>
      </p>
      <p class="text-base">
        <span class="font-semibold">Address:</span>
        <span id="addressText">—</span>
      </p>
      <p id="whenText" class="text-base">
        <span class="font-semibold">When:</span>
        <span id="whenValue">—</span>
      </p>
    </div>

    <div id="map" class="rounded-xl overflow-hidden mb-4 border border-gray-200"></div>

    <div class="flex gap-3">
      <a id="directionsBtn"
         href="#"
         target="_blank" rel="noopener"
         class="bg-orange-500 text-white px-4 py-2 rounded-xl shadow-md font-semibold transition hover:bg-orange-600 hover:shadow-lg">
        Get Directions
      </a>
    </div>
  </main>

  <script>
    // Grab the event payload from sessionStorage (set by results.html)
    const stored = sessionStorage.getItem('selected_event');
    const lastSearch = sessionStorage.getItem('last_search') || '';


    // Back to results preserves the last search query (if available)
    document.getElementById('backBtn').addEventListener('click', () => {
      const url = 'results.html' + (lastSearch ? lastSearch : '');
      window.location.href = url;
    });

    if (!stored) {
      // If the user navigated directly here without session state
      document.querySelector('main').innerHTML = `
        <div class="text-center py-12">
          <p class="text-gray-700 mb-4">We couldn't find that deal's details.</p>
          <a href="index.html" class="text-orange-600 underline">Go back to search</a>
        </div>
      `;
    } else {
      const ev = JSON.parse(stored);

      // Fill basic fields
      document.getElementById('dealName').textContent = ev.name || 'Untitled Event';
      document.getElementById('dealType').textContent = ev.type || '';
      document.getElementById('locationName').textContent = ev.address_name || '—';
      document.getElementById('addressText').textContent = ev.address || '—';
      const when = ev.start_time ? new Date(ev.start_time).toLocaleString() : '';
      document.getElementById('whenValue').textContent = when || '—';

      // Map + marker (Leaflet)
      async function ensureLatLon() {
        if (ev.lat != null && ev.lon != null) return { lat: ev.lat, lon: ev.lon };

        // Fallback: geocode address if we don't have coordinates
        if (ev.address) {
          try {
            const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(ev.address)}`);
            const j = await r.json();
            if (Array.isArray(j) && j.length) {
              return { lat: parseFloat(j[0].lat), lon: parseFloat(j[0].lon) };
            }
          } catch {}
        }
        return null;
      }

      (async () => {
        const coords = await ensureLatLon();
        // Initialize map
        const map = L.map('map');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        if (coords) {
          const { lat, lon } = coords;
          const marker = L.marker([lat, lon]).addTo(map);
          const title = ev.name || 'Deal';
          const subtitle = ev.address_name || ev.address || '';
          marker.bindPopup(`<strong>${title}</strong><br>${subtitle}`).openPopup();
          map.setView([lat, lon], 15);

          // Directions button prefers coordinates if available
          document.getElementById('directionsBtn').href =
            `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`;
        } else {
          // Default view if no coords/address
          map.setView([35.2271, -80.8431], 12); // Charlotte, NC as fallback
          // Directions falls back to address (may still be null)
          const dest = ev.address ? encodeURIComponent(ev.address) : encodeURIComponent('Charlotte, NC');
          document.getElementById('directionsBtn').href =
            `https://www.google.com/maps/dir/?api=1&destination=${dest}`;
        }
      })();
    }
  </script>
</body>
</html>
